build:
  # This references an OpenJDK container from the
  # Docker Hub https://hub.docker.com/_/openjdk/
  # Read more about containers on our dev center
  # https://devcenter.wercker.com/overview-and-core-concepts/containers/
  box:
    id: gcr.io/justto-ml/node
    username: _json_key
    password: $JUSTTO_ML_KEY
    tag: latest
    registry: gcr.io

  # Steps make up the actions in your pipeline
  # Read more about steps on our dev center:
  # https://devcenter.wercker.com/development/steps/
  steps:
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: SHA256:nThbg6kXUpJWGl7E1IGOCspRomTxdCARLviKw6E5SY8
    - add-ssh-key:
        keyname: werker
    - script:
      name: Configure project informations
      code: |
        export PROJECT_NAME=justto-web
        unset VUE_APP_BASE_URL
        export VUE_APP_BASE_URL=https://backend.justto.app/
    - install-packages:
        packages: curl
    - script:
      name: Configure git
      code: |
        git config --global user.name "wercker" && git config --global user.email "dev@justto.com.br"
        git remote set-url origin git@github.com:justto-produto/justto-web.git
    - script:
      name: Prepare release branch
      code: |
        git reset --hard
        git checkout master
        git pull origin master
        git merge develop --commit -m "Merge com a develop para release"
    - script:
        name: Run npm i
        code: |
          rm -rf node_modules && rm package-lock.json && npm i --legacy-peer-deps
    - script:
        name: Run npm run release
        code: |
          npm run release
          export CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo $CURRENT_VERSION
    - script:
        name: Update tag version
        code: |
          git add .
          git commit -m 'Release da versao '${CURRENT_VERSION} || echo 'Nada a commitar.'
          git push origin master
    - wercker/s3sync@2.2.2:
      key_id: $AWS_KEY_ID
      key_secret: $AWS_KEY_SECRET
      bucket_url: $AWS_S3_SITE
      source-dir: dist
      delete_removed: false
    - paulomedeiros/invalidate-cloudfront@0.0.1:
      secret: $AWS_KEY_SECRET
      key: $AWS_KEY_ID
      wait: true
      paths: "/*"
      distribution: "E23JG6RJ6E0JUM"